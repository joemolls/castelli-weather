<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>{{ location_name }} - 72h Forecast</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
    h1 { text-align: center; color: #333; }
    .chart-container { max-width: 1000px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .day-labels { 
      max-width: 1000px; 
      margin: 10px auto 0 auto; 
      display: flex; 
      background: white;
      padding: 15px 20px;
      border-radius: 8px 8px 0 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-bottom: 2px solid #3498db;
    }
    .day-label { 
      font-weight: bold; 
      font-size: 16px;
      color: #2c3e50;
      text-align: center;
      flex: 1;
      text-transform: capitalize;
    }
    footer {
      max-width: 1000px;
      margin: 50px auto 20px auto;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      color: #7f8c8d;
      font-size: 14px;
      line-height: 1.6;
    }
    footer h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 16px;
    }
    footer a {
      color: #3498db;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .data-source {
      margin: 10px 0;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
  <h1>Previsioni 72h - {{ location_name }}</h1>
  
  <div class="day-labels" id="dayLabels"></div>
  
  <div class="chart-container" style="border-radius: 0 0 8px 8px; margin-top: 0;">
    <canvas id="weatherChart"></canvas>
  </div>
  
  <footer>
    <h3>ðŸ“Š Fonti dei Dati</h3>
    <div class="data-source">
      <strong>Dati meteorologici:</strong> 
      <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a> - 
      Servizio gratuito di previsioni meteorologiche basato su modelli numerici open-source
    </div>
    <div class="data-source">
      <strong>API utilizzata:</strong> 
      <a href="https://open-meteo.com/en/docs" target="_blank">Open-Meteo Forecast API</a>
    </div>
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; font-size: 12px;">
      I dati sono aggiornati in tempo reale e provengono da modelli meteorologici pubblici. 
      Per maggiori informazioni visita <a href="https://open-meteo.com/" target="_blank">open-meteo.com</a>
    </div>
  </footer>
  
  <script>
    const data = {{ hourly | tojson }};
    
    // Creiamo le labels e separazioni per i giorni
    const labels = data.time.map(t => new Date(t));
    
    // Troviamo gli indici in cui cambia il giorno
    const daySeparators = [];
    const dayRanges = [];
    let prevDay = labels[0].getDate();
    let dayStart = 0;
    
    labels.forEach((dt, i) => {
      if (dt.getDate() !== prevDay) {
        daySeparators.push(i);
        dayRanges.push({ start: dayStart, end: i - 1, date: labels[dayStart] });
        dayStart = i;
        prevDay = dt.getDate();
      }
    });
    // Aggiungi l'ultimo giorno
    dayRanges.push({ start: dayStart, end: labels.length - 1, date: labels[dayStart] });
    
    // Crea le etichette dei giorni
    const dayLabelsContainer = document.getElementById('dayLabels');
    dayRanges.forEach(range => {
      const div = document.createElement('div');
      div.className = 'day-label';
      const dayName = range.date.toLocaleDateString('it-IT', { weekday: 'long' });
      const dayDate = range.date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
      div.innerHTML = `${dayName}<br><small style="color: #7f8c8d;">${dayDate}</small>`;
      dayLabelsContainer.appendChild(div);
    });
    
    // Crea il grafico combinato
    const ctx = document.getElementById('weatherChart');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels.map(d => d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'})),
        datasets: [
          {
            type: 'bar',
            label: 'Precipitazioni (mm)',
            data: data.precipitation,
            backgroundColor: 'rgba(52, 152, 219, 0.6)',
            borderColor: 'rgba(52, 152, 219, 1)',
            borderWidth: 1,
            yAxisID: 'y1',
            order: 2
          },
          {
            type: 'line',
            label: 'Temperatura (Â°C)',
            data: data.temperature_2m,
            borderColor: 'rgba(231, 76, 60, 1)',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            yAxisID: 'y',
            order: 1,
            pointRadius: 2,
            pointHoverRadius: 5
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        plugins: {
          title: {
            display: true,
            text: 'Temperatura e Precipitazioni - Previsioni 72 ore',
            font: { size: 18, weight: 'bold' },
            color: '#2c3e50'
          },
          legend: { 
            display: true,
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 15
            }
          },
          annotation: {
            annotations: daySeparators.reduce((acc, idx, i) => {
              const key = `day${idx}`;
              acc[key] = {
                type: 'line',
                scaleID: 'x',
                value: idx - 0.5,
                borderColor: 'rgba(149, 165, 166, 0.5)',
                borderWidth: 2,
                borderDash: [5, 5]
              };
              return acc;
            }, {})
          },
          tooltip: {
            callbacks: {
              title: function(context) {
                const index = context[0].dataIndex;
                return labels[index].toLocaleString('it-IT', { 
                  weekday: 'short', 
                  day: 'numeric', 
                  month: 'short',
                  hour: '2-digit',
                  minute: '2-digit'
                });
              }
            }
          }
        },
        scales: {
          x: { 
            ticks: { 
              maxRotation: 90, 
              minRotation: 45, 
              autoSkip: true, 
              maxTicksLimit: 24,
              font: { size: 10 }
            },
            grid: {
              display: false
            }
          },
          y: {
            type: 'linear',
            display: true,
            position: 'left',
            title: {
              display: true,
              text: 'Temperatura (Â°C)',
              color: 'rgba(231, 76, 60, 1)',
              font: { weight: 'bold' }
            },
            ticks: {
              color: 'rgba(231, 76, 60, 1)'
            }
          },
          y1: {
            type: 'linear',
            display: true,
            position: 'right',
            title: {
              display: true,
              text: 'Precipitazioni (mm)',
              color: 'rgba(52, 152, 219, 1)',
              font: { weight: 'bold' }
            },
            ticks: {
              color: 'rgba(52, 152, 219, 1)'
            },
            grid: {
              drawOnChartArea: false,
            },
            beginAtZero: true
          }
        }
      }
    });
  </script>
</body>
</html>
