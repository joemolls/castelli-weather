<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MTB Meteo">
  <meta name="theme-color" content="#2c3e50">
  <title>Castelli Romani - Previsioni Meteo MTB</title>
  <link rel="icon" href="https://em-content.zobj.net/thumbs/120/apple/354/mountain_26f0-fe0f.png" type="image/png">
  <link rel="manifest" href="/static/manifest.json">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 0;
      padding: 15px; 
      background-color: #ecf0f1;
    }
    
    .title-container {
      max-width: 1000px;
      margin: 0 auto 8px auto;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    h1 { 
      color: #2c3e50;
      margin: 0;
      text-align: center;
    }
    
    /* Link Avvisi - verde sobrio */
    .avvisi-link {
  display: inline-block;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 10px 25px;
  border-radius: 25px;
  text-decoration: none;
  font-weight: bold;
  font-size: 14px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transition: transform 0.2s;
  white-space: nowrap;
}

.avvisi-link:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
    
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .last-update {
      text-align: center;
      color: #95a5a6;
      font-size: 12px;
      margin-bottom: 15px;
    }
    
    /* MTB Info - Layout compatto su una riga */
    .mtb-compact {
      max-width: 1000px;
      margin: 15px auto;
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      box-sizing: border-box;
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr;
      gap: 15px;
      align-items: start;
    }
    
    .compact-section {
      padding: 0;
    }
    
    .compact-section h3 {
      margin: 0 0 8px 0;
      color: #2c3e50;
      font-size: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 6px;
    }
    
    .trail-score-compact {
      text-align: center;
      padding: 10px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    
    .trail-score-compact.excellent {
      background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
      color: white;
    }
    
    .trail-score-compact.good {
      background: linear-gradient(135deg, #f7b733 0%, #fc4a1a 100%);
      color: white;
    }
    
    .trail-score-compact.poor {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      color: white;
    }
    
    .condition-list-compact {
      list-style: none;
      padding: 0;
      margin: 6px 0 0 0;
      font-size: 12px;
    }
    
    .condition-list-compact li {
      padding: 3px 0;
    }
    
    .wind-compact {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }
    
    .condition-legend {
      margin-top: 8px;
      border-top: 1px solid #ecf0f1;
      padding-top: 6px;
    }
    .condition-legend-title {
      font-size: 10px;
      color: #95a5a6;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .legend-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2px 6px;
    }
    .legend-item {
      font-size: 10px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 3px;
      white-space: nowrap;
    }
    .legend-mm {
      color: #95a5a6;
      font-size: 9px;
    }
    
    /* Soil Dryness ‚Äî inline compact */
    .soil-dryness-inline {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid #ecf0f1;
      font-size: 11px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }
    .soil-dryness-dot {
      display: inline-block;
      width: 8px; height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Storico 14 giorni */
    .history-section {
      max-width: 1000px;
      margin: 15px auto;
      background: white;
      border-radius: 8px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      box-sizing: border-box;
    }
    .history-section h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      font-size: 15px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 6px;
    }
    .history-chart-container {
      height: 160px;
      position: relative;
    }

    .trail-warning-badge {
      display: inline-block;
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 3px;
      width: 100%;
      box-sizing: border-box;
    }
    
    .wind-box-compact {
      flex: 1;
      text-align: center;
      background: #f8f9fa;
      padding: 8px 6px;
      border-radius: 6px;
    }
    
    .wind-box-compact .value {
      font-size: 18px;
      font-weight: bold;
      color: #3498db;
    }
    
    .wind-box-compact .label {
      font-size: 9px;
      color: #7f8c8d;
      margin-top: 2px;
    }
    
    .riding-windows-compact {
      margin-top: 6px;
    }
    
    .day-window {
      background: #f8f9fa;
      padding: 8px 10px;
      border-radius: 6px;
      margin-bottom: 6px;
      border-left: 4px solid #3498db;
    }
    
    .day-window.excellent {
      border-left-color: #56ab2f;
    }
    
    .day-window.good {
      border-left-color: #f7b733;
    }
    
    .day-window.poor {
      border-left-color: #eb3349;
    }
    
    .day-window-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }
    
    .day-window-title {
      font-weight: bold;
      font-size: 14px;
      color: #2c3e50;
    }
    
    .day-window-time {
      font-size: 13px;
      color: #7f8c8d;
    }
    
    .day-window-details {
      font-size: 12px;
      color: #7f8c8d;
    }
    
    .location-section {
      max-width: 1000px;
      margin: 15px auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .location-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .location-name {
      font-size: 20px;
      font-weight: bold;
    }
    .location-elevation {
      font-size: 13px;
      opacity: 0.9;
    }
    .day-labels { 
      display: flex; 
      padding: 12px 15px;
      border-bottom: 2px solid #3498db;
      background: #f8f9fa;
    }
    .day-label { 
      font-weight: bold; 
      font-size: 14px;
      color: #2c3e50;
      text-align: center;
      flex: 1;
      text-transform: capitalize;
    }
    .weather-icon {
      font-size: 22px;
      display: block;
      margin: 3px 0;
    }
    .chart-container {
      padding: 15px;
      height: 280px;
    }
    footer {
      max-width: 1000px;
      margin: 30px auto 15px auto;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
      color: #7f8c8d;
      font-size: 13px;
      line-height: 1.5;
    }
    footer h3 {
      color: #2c3e50;
      margin-bottom: 12px;
      font-size: 15px;
    }
    footer a {
      color: #3498db;
      text-decoration: none;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .data-source {
      margin: 10px 0;
    }
    .update-info-box {
      background: #f8f9fa;
      border-left: 4px solid #3498db;
      padding: 12px;
      margin: 15px 0;
      text-align: left;
      border-radius: 4px;
    }
    .update-info-box h4 {
      margin: 0 0 8px 0;
      color: #2c3e50;
      font-size: 14px;
    }
    .update-info-box ul {
      margin: 4px 0;
      padding-left: 18px;
    }
    .update-info-box li {
      margin: 4px 0;
      font-size: 12px;
    }
    
    @media (max-width: 768px) {
      .title-container {
        flex-direction: column;
        gap: 10px;
      }
      
      h1 {
        font-size: 24px;
      }
      
      .mtb-compact {
        grid-template-columns: 1fr;
      }
      .wind-compact {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
  <div class="title-container">
    <h1>üèîÔ∏è Castelli Romani - Meteo MTB</h1>
    <a href="/avvisi" class="avvisi-link">üîó Link Utili</a>
    <a href="/percorsi" class="avvisi-link">üó∫Ô∏è Percorsi</a>
  </div>
  <div class="subtitle">Previsioni a 72 ore + Condizioni Sentieri XCM</div>
  <div class="last-update">
    üìÖ Ultimo aggiornamento: <span id="currentTime"></span>
  </div>
  
  <!-- MTB Info Compact - Tutto su una riga -->
  <div class="mtb-compact">
    <!-- Condizioni Sentieri + Soil Dryness -->
    <div class="compact-section">
      <h3>üö¥‚Äç‚ôÇÔ∏è Condizioni Sentieri</h3>
      <div class="trail-score-compact {{ trail_conditions.rating }}">
        {{ trail_conditions.rating_emoji }} {{ trail_conditions.rating_text }}
      </div>
      <ul class="condition-list-compact">
        {% for reason in trail_conditions.reasons[:3] %}
        <li>{{ reason }}</li>
        {% endfor %}
      </ul>
      {% if soil_dryness %}
      <div class="soil-dryness-inline">
        <span class="soil-dryness-dot" style="background:{{ soil_dryness.color }}"></span>
        üå± Terreno: <strong style="color:{{ soil_dryness.color }}">{{ soil_dryness.label }}</strong>
        ‚Äî {{ soil_dryness.dry_days }} giorni senza pioggia
      </div>
      {% endif %}
    </div>
    
    <!-- Quando Uscire -->
    <div class="compact-section">
      <h3>‚è∞ Quando uscire?</h3>
      <div class="riding-windows-compact">
        {% for window in riding_windows %}
        <div class="day-window {{ window.rating }}">
          <div class="day-window-header">
            <span class="day-window-title">{{ window.rating_icon }} {{ window.day }}</span>
            <span class="day-window-time">{{ window.start_time }}-{{ window.end_time }} ({{ window.duration }}h)</span>
          </div>
          <div class="day-window-details">
            üå°Ô∏è {{ window.temp | round(0) }}¬∞C ¬∑ üí® {{ window.wind | round(0) }} km/h ¬∑ üíß {{ window.precip | round(1) }}mm
          </div>
          {% if loop.first and trail_conditions.rating == 'poor' %}
          <div class="trail-warning-badge">‚ö†Ô∏è Terreno saturo ({{ trail_conditions.rain_24h | round(1) }}mm/24h) ‚Äî sentieri danneggiati</div>
          {% endif %}
        </div>
        {% endfor %}
        {% if riding_windows|length == 0 %}
        <div class="day-window poor">
          <div class="day-window-title">üî¥ Nessuna finestra ideale</div>
          <div class="day-window-details">Condizioni non favorevoli per XCM nei prossimi 3 giorni</div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Vento in Quota -->
    <div class="compact-section">
      <h3>üí® Vento in Quota</h3>
      <div class="wind-compact">
        <div class="wind-box-compact">
          <div class="value">{{ trail_conditions.current_wind | round(0) | int }}</div>
          <div class="label">km/h<br>Vento</div>
        </div>
        <div class="wind-box-compact">
          <div class="value">{{ trail_conditions.current_gust | round(0) | int }}</div>
          <div class="label">km/h<br>Raffica</div>
        </div>
        <div class="wind-box-compact">
          <div class="value">{{ trail_conditions.rain_24h | round(1) }}</div>
          <div class="label">mm<br>24h</div>
        </div>
      </div>
      <div class="condition-legend">
        <div class="condition-legend-title">Legenda precipitazioni</div>
        <div class="legend-grid">
          <div class="legend-item">‚úÖ <span>Asciutto <span class="legend-mm">&lt;1mm</span></span></div>
          <div class="legend-item">üü¢ <span>Sentieri OK <span class="legend-mm">&lt;3mm</span></span></div>
          <div class="legend-item">üü° <span>Umidit√† <span class="legend-mm">&lt;5mm</span></span></div>
          <div class="legend-item">üü† <span>Bagnati <span class="legend-mm">&lt;10mm</span></span></div>
          <div class="legend-item">üî¥ <span>Fango <span class="legend-mm">&lt;20mm</span></span></div>
          <div class="legend-item">‚õî <span>Intenso <span class="legend-mm">‚â•20mm</span></span></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Location Sections -->
  {% for location in locations_data %}
  <div class="location-section">
    <div class="location-header">
      <div class="location-name">{{ location.name }}</div>
      <div class="location-elevation">‚õ∞Ô∏è {{ location.elevation }}m s.l.m.</div>
    </div>
    
    <div class="day-labels" id="dayLabels{{ loop.index }}"></div>
    
    <div class="chart-container">
      <canvas id="chart{{ loop.index }}"></canvas>
    </div>
  </div>

  {% if location.soil_dryness and location.soil_dryness.history %}
  <div class="history-section">
    <h3>üìÖ Storico Precipitazioni ‚Äî ultimi 7 giorni ({{ location.name }})</h3>
    <div class="history-chart-container">
      <canvas id="historyChart{{ loop.index }}"></canvas>
    </div>
  </div>
  {% endif %}

  {% endfor %}

  <footer>
    <h3>üìä Fonti dei Dati</h3>
    <div class="data-source">
      <strong>Dati meteorologici:</strong> 
      <a href="https://open-meteo.com/" target="_blank">Open-Meteo</a> - 
      Servizio gratuito di previsioni meteorologiche basato su modelli numerici open-source
    </div>
    <div class="data-source">
      <strong>API utilizzata:</strong> 
      <a href="https://open-meteo.com/en/docs" target="_blank">Open-Meteo Forecast API</a>
    </div>
    <div class="data-source">
      <strong>Coordinate geografiche:</strong> 
      Rilevate dalle localit√† dei Castelli Romani (Lazio, Italia)
    </div>
    
    <div class="update-info-box">
      <h4>üîÑ Frequenza Aggiornamento Dati</h4>
      <ul style="text-align: left;">
        <li><strong>Modello meteorologico:</strong> DWD ICON (risoluzione 7km, ottimizzato per Europa)</li>
        <li><strong>Aggiornamenti:</strong> ogni 3 ore</li>
        <li><strong>Disponibilit√† dati:</strong> entro 1-2 ore dall'aggiornamento del modello</li>
        <li><strong>Fonte:</strong> DWD (Deutscher Wetterdienst - Servizio Meteorologico Tedesco)</li>
        <li><strong>Questa pagina:</strong> si aggiorna ad ogni visita con i dati pi√π recenti disponibili</li>
      </ul>
    </div>
    
    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; font-size: 12px;">
      I dati sono aggiornati in tempo reale e provengono da modelli meteorologici pubblici. 
      Per maggiori informazioni visita <a href="https://open-meteo.com/" target="_blank">open-meteo.com</a>
    </div>

    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ecf0f1; font-size: 12px; color: #95a5a6;">
      üëÅÔ∏è Visite oggi: <strong style="color: #2c3e50;">{{ visit_stats.today }}</strong> &nbsp;|&nbsp;
      Questo mese: <strong style="color: #2c3e50;">{{ visit_stats.this_month }}</strong> &nbsp;|&nbsp;
      Totale: <strong style="color: #2c3e50;">{{ visit_stats.total }}</strong>
    </div>
    <div style="margin-top: 8px; font-size: 12px; color: #95a5a6;">
      Test App by <strong style="color: #2c3e50;">G.Mollo</strong>
    </div>


  </footer>
  
  <script>
    // ‚îÄ‚îÄ Registrazione Service Worker (PWA) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/service_worker.js')
          .then(reg => console.log('‚úÖ Service Worker registrato:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è Service Worker non registrato:', err));
      });
    }
  </script>

  <script>
    // Mostra l'ora corrente di aggiornamento
    const now = new Date();
    const timeString = now.toLocaleString('it-IT', {
      weekday: 'short',
      day: 'numeric',
      month: 'short',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    document.getElementById('currentTime').textContent = timeString;
    
    const locationsData = {{ locations_data | tojson }};
    
    function getWeatherIcon(code) {
      const weatherIcons = {
        0: '‚òÄÔ∏è', 1: 'üå§Ô∏è', 2: '‚õÖ', 3: '‚òÅÔ∏è',
        45: 'üå´Ô∏è', 48: 'üå´Ô∏è',
        51: 'üå¶Ô∏è', 53: 'üå¶Ô∏è', 55: 'üåßÔ∏è',
        61: 'üåßÔ∏è', 63: 'üåßÔ∏è', 65: 'üåßÔ∏è',
        71: 'üå®Ô∏è', 73: 'üå®Ô∏è', 75: 'üå®Ô∏è', 77: '‚ùÑÔ∏è',
        80: 'üå¶Ô∏è', 81: 'üåßÔ∏è', 82: '‚õàÔ∏è',
        85: 'üå®Ô∏è', 86: 'üå®Ô∏è',
        95: '‚õàÔ∏è', 96: '‚õàÔ∏è', 99: '‚õàÔ∏è'
      };
      return weatherIcons[code] || 'üå°Ô∏è';
    }
    
    function getWeatherDescription(code) {
      const descriptions = {
        0: 'Cielo sereno', 1: 'Principalmente sereno', 2: 'Parzialmente nuvoloso', 3: 'Coperto',
        45: 'Nebbia', 48: 'Nebbia con brina',
        51: 'Pioggerella leggera', 53: 'Pioggerella moderata', 55: 'Pioggerella intensa',
        61: 'Pioggia leggera', 63: 'Pioggia moderata', 65: 'Pioggia forte',
        71: 'Neve leggera', 73: 'Neve moderata', 75: 'Neve intensa', 77: 'Nevischio',
        80: 'Rovesci leggeri', 81: 'Rovesci moderati', 82: 'Rovesci violenti',
        85: 'Nevicate leggere', 86: 'Nevicate intense',
        95: 'Temporale', 96: 'Temporale con grandine', 99: 'Temporale forte con grandine'
      };
      return descriptions[code] || 'Variabile';
    }
    
    // Funzione per determinare il colore della barra in base all'intensit√† della pioggia
    // Scala di blu: azzurro chiaro -> blu navy
    function getRainColor(precip) {
      if (precip === 0) return 'rgba(220, 220, 220, 0.3)';     // Grigio chiaro per nessuna pioggia
      if (precip < 2) return 'rgba(174, 214, 241, 0.8)';       // Azzurro chiarissimo
      if (precip < 3) return 'rgba(133, 193, 233, 0.85)';      // Azzurro chiaro
      if (precip < 5) return 'rgba(52, 152, 219, 0.9)';        // Blu medio
      if (precip < 10) return 'rgba(41, 128, 185, 0.95)';      // Blu intenso
      return 'rgba(21, 67, 96, 1)';                            // Blu navy per pioggia molto intensa
    }
    
    // Funzione per descrivere le condizioni MTB in base alla pioggia
    function getMTBCondition(precip) {
      if (precip === 0) return '‚úÖ Asciutto';
      if (precip < 1) return 'üü¢ Sentieri OK';
      if (precip < 3) return 'üü° Leggera umidit√†';
      if (precip < 5) return 'üü† Sentieri bagnati';
      if (precip < 10) return 'üî¥ Fango moderato';
      return '‚õî Fango intenso';
    }
    
    function createChart(data, chartId, dayLabelsId) {
      if (!data || !data.hourly || !data.hourly.time || data.hourly.time.length === 0) {
        console.error('No data available for chart:', chartId);
        return;
      }
      
      const labels = data.hourly.time.map(t => new Date(t));
      const precipData = data.hourly.precipitation || [];
      
      // Crea array di colori dinamici per ogni barra
      const rainColors = precipData.map(p => getRainColor(p));
      
      const daySeparators = [];
      const dayRanges = [];
      let prevDay = labels[0].getDate();
      let dayStart = 0;
      
      labels.forEach((dt, i) => {
        if (dt.getDate() !== prevDay) {
          daySeparators.push(i);
          dayRanges.push({ start: dayStart, end: i - 1, date: labels[dayStart] });
          dayStart = i;
          prevDay = dt.getDate();
        }
      });
      dayRanges.push({ start: dayStart, end: labels.length - 1, date: labels[dayStart] });
      
      const dayLabelsContainer = document.getElementById(dayLabelsId);
      if (dayLabelsContainer) {
        dayRanges.forEach(range => {
          const div = document.createElement('div');
          div.className = 'day-label';
          const dayName = range.date.toLocaleDateString('it-IT', { weekday: 'long' });
          const dayDate = range.date.toLocaleDateString('it-IT', { day: 'numeric', month: 'short' });
          
          const midDayIndex = range.start + Math.floor((range.end - range.start) / 2);
          const weatherCode = data.hourly.weather_code && data.hourly.weather_code[midDayIndex] 
            ? data.hourly.weather_code[midDayIndex] 
            : 0;
          const icon = getWeatherIcon(weatherCode);
          
          div.innerHTML = `
            <span class="weather-icon">${icon}</span>
            ${dayName}<br>
            <small style="color: #7f8c8d;">${dayDate}</small>
          `;
          dayLabelsContainer.appendChild(div);
        });
      }
      
      const ctx = document.getElementById(chartId);
      if (!ctx) {
        console.error('Canvas element not found:', chartId);
        return;
      }
      
      // Configurazione annotazioni con linea a 5mm
      const annotations = {
        ...daySeparators.reduce((acc, idx) => {
          acc[`day${idx}`] = {
            type: 'line', 
            scaleID: 'x', 
            value: idx - 0.5,
            borderColor: 'rgba(149, 165, 166, 0.5)', 
            borderWidth: 2, 
            borderDash: [5, 5]
          };
          return acc;
        }, {}),

      };
      
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels.map(d => d.toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'})),
          datasets: [
            {
              type: 'bar',
              label: 'Precipitazioni (mm)',
              data: precipData,
              backgroundColor: rainColors,
              borderColor: rainColors.map(c => c.replace('0.', '1.')), // Bordi pi√π intensi
              borderWidth: 1,
              yAxisID: 'y1',
              order: 3
            },
            {
              type: 'line',
              label: 'Temperatura (¬∞C)',
              data: data.hourly.temperature_2m || [],
              borderColor: 'rgba(231, 76, 60, 1)',
              backgroundColor: 'rgba(231, 76, 60, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              yAxisID: 'y',
              order: 1,
              pointRadius: 2,
              pointHoverRadius: 5
            },
            {
              type: 'line',
              label: 'Vento (km/h)',
              data: data.hourly.windspeed_10m || [],
              borderColor: 'rgba(46, 204, 113, 1)',
              backgroundColor: 'rgba(46, 204, 113, 0.1)',
              borderWidth: 2,
              borderDash: [5, 5],
              fill: false,
              tension: 0.3,
              yAxisID: 'y2',
              order: 2,
              pointRadius: 1,
              pointHoverRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 15 } },
            annotation: {
              annotations: annotations
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const index = context[0].dataIndex;
                  return labels[index].toLocaleString('it-IT', { 
                    weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                  });
                },
                afterTitle: function(context) {
                  const index = context[0].dataIndex;
                  const weatherCode = data.hourly.weather_code ? data.hourly.weather_code[index] : 0;
                  const wind = data.hourly.windspeed_10m ? data.hourly.windspeed_10m[index] : 0;
                  const gust = data.hourly.windgusts_10m ? data.hourly.windgusts_10m[index] : 0;
                  const precip = precipData[index] || 0;
                  const icon = getWeatherIcon(weatherCode);
                  const desc = getWeatherDescription(weatherCode);
                  const mtbCondition = getMTBCondition(precip);
                  return `${icon} ${desc}\nüí® Raffiche: ${gust.toFixed(0)} km/h\nüö¥ ${mtbCondition}`;
                }
              }
            }
          },
          scales: {
            x: { 
              ticks: { maxRotation: 90, minRotation: 45, autoSkip: true, maxTicksLimit: 24, font: { size: 10 } }, 
              grid: { display: false } 
            },
            y: {
              type: 'linear', display: true, position: 'left',
              title: { display: true, text: 'Temperatura (¬∞C)', color: 'rgba(231, 76, 60, 1)', font: { weight: 'bold', size: 11 } },
              ticks: { color: 'rgba(231, 76, 60, 1)' },
              min: -5,
              max: 35
            },
            y1: {
              type: 'linear', 
              display: true, 
              position: 'right',
              title: { display: true, text: 'Precipitazioni (mm)', color: 'rgba(52, 152, 219, 1)', font: { weight: 'bold', size: 11 } },
              ticks: { color: 'rgba(52, 152, 219, 1)' },
              grid: { drawOnChartArea: false }, 
              min: 0,
              max: 20, // Scala fissa 0-20mm
              ticks: {
                stepSize: 5,
                callback: function(value) {
                  if (value === 5) return '5mm ‚ö†Ô∏è';
                  return value + 'mm';
                }
              }
            },
            y2: {
              type: 'linear', display: false, position: 'right',
              grid: { drawOnChartArea: false }, 
              beginAtZero: true,
              max: 60
            }
          }
        }
      });
    }
    
    // Crea tutti i grafici previsioni
    console.log('Creating charts for', locationsData.length, 'locations');
    locationsData.forEach((location, index) => {
      console.log('Creating chart for:', location.name);
      createChart(location, `chart${index + 1}`, `dayLabels${index + 1}`);
    });

    // ‚îÄ‚îÄ Grafici storici per ogni localit√† ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function createHistoryChart(canvasId, historyData) {
      var ctx = document.getElementById(canvasId);
      if (!ctx || !historyData || !historyData.length) return;

      var labels   = historyData.map(function(d) { return d.day + ' ' + d.date; });
      var precips  = historyData.map(function(d) { return d.precip; });
      var tempMax  = historyData.map(function(d) { return d.temp_max; });
      var tempMin  = historyData.map(function(d) { return d.temp_min; });

      // Colori barre: verde se <2mm (dry), giallo <10mm, arancio <25mm, rosso ‚â•25mm
      var barColors = precips.map(function(p) {
        if (p < 2)  return 'rgba(39, 174, 96, 0.7)';
        if (p < 10) return 'rgba(247, 183, 51, 0.8)';
        if (p < 25) return 'rgba(230, 126, 34, 0.85)';
        return 'rgba(231, 76, 60, 0.9)';
      });

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              type: 'bar',
              label: 'Precipitazioni (mm)',
              data: precips,
              backgroundColor: barColors,
              borderColor: barColors.map(function(c) { return c.replace('0.7','1').replace('0.8','1').replace('0.85','1').replace('0.9','1'); }),
              borderWidth: 1,
              yAxisID: 'yPrecip',
              order: 2
            },
            {
              type: 'line',
              label: 'Temp Max (¬∞C)',
              data: tempMax,
              borderColor: 'rgba(231, 76, 60, 0.9)',
              backgroundColor: 'transparent',
              borderWidth: 2,
              pointRadius: 3,
              tension: 0.3,
              yAxisID: 'yTemp',
              order: 1
            },
            {
              type: 'line',
              label: 'Temp Min (¬∞C)',
              data: tempMin,
              borderColor: 'rgba(52, 152, 219, 0.9)',
              backgroundColor: 'transparent',
              borderWidth: 1.5,
              pointRadius: 2,
              borderDash: [4, 3],
              tension: 0.3,
              yAxisID: 'yTemp',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 14 } },
            tooltip: {
              callbacks: {
                label: function(ctx) {
                  if (ctx.dataset.yAxisID === 'yPrecip') return ' ' + ctx.parsed.y + ' mm';
                  return ' ' + ctx.parsed.y + ' ¬∞C';
                },
                afterBody: function(items) {
                  var p = items[0] ? precips[items[0].dataIndex] : 0;
                  if (p < 2)  return ['üü¢ Terreno: asciutto'];
                  if (p < 10) return ['üü° Terreno: umido'];
                  if (p < 25) return ['üü† Terreno: bagnato'];
                  return ['üî¥ Terreno: saturo'];
                }
              }
            }
          },
          scales: {
            x: {
              ticks: { font: { size: 10 }, maxRotation: 45 },
              grid: { display: false }
            },
            yPrecip: {
              type: 'linear',
              position: 'right',
              title: { display: true, text: 'Precipitazioni (mm)', color: 'rgba(52,152,219,1)', font: { size: 10 } },
              ticks: { color: 'rgba(52,152,219,1)', font: { size: 10 },
                callback: function(v) { return v + 'mm'; }
              },
              grid: { drawOnChartArea: false },
              min: 0
            },
            yTemp: {
              type: 'linear',
              position: 'left',
              title: { display: true, text: 'Temperatura (¬∞C)', color: 'rgba(231,76,60,1)', font: { size: 10 } },
              ticks: { color: 'rgba(100,100,100,0.8)', font: { size: 10 },
                callback: function(v) { return v + '¬∞'; }
              },
              grid: { color: 'rgba(0,0,0,0.04)' }
            }
          }
        }
      });
    }

    // Crea un grafico storico per ogni location che ha soil_dryness
    {% for location in locations_data %}
    {% if location.soil_dryness and location.soil_dryness.history %}
    createHistoryChart('historyChart{{ loop.index }}', {{ location.soil_dryness.history | tojson }});
    {% endif %}
    {% endfor %}
  </script>
</body>
</html>
